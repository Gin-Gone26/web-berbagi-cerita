async function syncStories(){const t=await idb.openDB("cerita-db",1),e=await t.getAll("pending-stories");for(const n of e)try{const e=new FormData;if(e.append("description",n.description||""),n.lat&&e.append("lat",n.lat),n.lon&&e.append("lon",n.lon),n.photoBuffer){const t=new Blob([n.photoBuffer],{type:n.photoType||"image/jpeg"});e.append("photo",t,"photo.jpg")}await fetch("https://story-api.dicoding.dev/v1/stories",{method:"POST",headers:{Authorization:"Bearer "+(n.token||"")},body:e}),await t.delete("pending-stories",n.id),console.log("✅ Synced story:",n.id)}catch(t){console.error("❌ Gagal sync story:",n.id,t)}}importScripts("/idb.js");const CACHE_NAME="cerita-static-v2",API_CACHE="cerita-api-v2",STATIC_ASSETS=["/","/index.html","/manifest.json","/favicon.ico","/icon-192.png","/icon-512.png","/icon-72.png","/fallback.png"];self.addEventListener("install",t=>{t.waitUntil(caches.open(CACHE_NAME).then(t=>t.addAll(STATIC_ASSETS)).catch(t=>console.error("❌ Cache gagal saat install:",t))),self.skipWaiting()}),self.addEventListener("activate",t=>{t.waitUntil(caches.keys().then(t=>Promise.all(t.filter(t=>t!==CACHE_NAME&&t!==API_CACHE).map(t=>caches.delete(t)))).then(()=>self.clients.claim()))}),self.addEventListener("fetch",t=>{new URL(t.request.url).origin.includes("story-api.dicoding.dev")?t.respondWith(caches.open(API_CACHE).then(async e=>{try{const n=await fetch(t.request);return e.put(t.request,n.clone()),n}catch{return e.match(t.request)}})):t.respondWith(caches.match(t.request).then(e=>e||fetch(t.request).then(e=>caches.open(CACHE_NAME).then(n=>(t.request.url.match(/\.(js|css)$/)&&n.put(t.request,e.clone()),e))).catch(()=>"document"===t.request.destination?caches.match("/index.html"):"image"===t.request.destination?caches.match("/fallback.png"):void 0)))}),self.addEventListener("push",t=>{console.log("📩 Push diterima:",t);let e={};if(t.data)try{e=t.data.json()}catch(e){console.warn("⚠️ Data push bukan JSON:",t.data.text())}const n=e.title||"Notifikasi Baru!",i=e.options||{body:"Anda mendapat update cerita baru.",icon:"/icon-192.png",badge:"/icon-72.png",data:{url:"/"},actions:[{action:"open",title:"Lihat Detail"},{action:"close",title:"Tutup"}]};t.waitUntil(self.registration.showNotification(n,i))}),self.addEventListener("notificationclick",t=>{if(t.notification.close(),"close"===t.action)return;const e=t.notification.data?.url||"/";t.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then(t=>{for(const n of t)if("focus"in n)return n.navigate(e),n.focus();if(clients.openWindow)return clients.openWindow(e)}))}),self.addEventListener("sync",t=>{"sync-new-story"===t.tag&&t.waitUntil(syncStories())});